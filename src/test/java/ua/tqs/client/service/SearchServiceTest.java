package ua.tqs.client.service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.internal.verification.VerificationModeFactory;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.client.RestTemplate;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

import com.fasterxml.jackson.core.JsonProcessingException;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.internal.verification.VerificationModeFactory;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;

import static org.assertj.core.api.Assertions.assertThat;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.JsonNode;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.client.RestTemplate;

import java.net.URI;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.when;
import static org.mockito.Mockito.verify;

@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.LENIENT)
public class SearchServiceTest {

    @Mock(lenient = true)
    private RestTemplate restTemplate;

    @InjectMocks
    private SearchService searchService;

    @Test
    public void whenGetAllProducts_ReturnOK() throws JsonProcessingException {
        String body = "[{\"id\":3,\"name\":\"Benuron\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmcia Geral\",\"description\":\"Great for small pains!\",\"price\":15,\"image\":\"someBase64Image\"},{\"id\":4,\"name\":\"Brufen\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmcia Geral\",\"description\":\"Great for small pains!\",\"price\":15,\"image\":\"someBase64Image\"},{\"id\":5,\"name\":\"Aerius 0,5 mg/ml solução oral\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Anti-histamínicos\",\"description\":\"Anti-histamínico para uso sistémico\",\"price\":5,\"image\":\"someBase64Image\"},{\"id\":6,\"name\":\"Pulmicort Nasal Aqua\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Descongestionantes\",\"description\":\"Descongestionante e outras preparações nasais para uso tópico\",\"price\":20,\"image\":\"someBase64Image\"},{\"id\":7,\"name\":\"Betadine Alcoólica Dérmica\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Anti-sépticos e desinfetantes\",\"description\":\"Anti-sépticos e desinfetantes\",\"price\":4,\"image\":\"someBase64Image\"},{\"id\":13,\"name\":\"TestProduct1450\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":18,\"name\":\"TestProduct1269\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":23,\"name\":\"TestProduct1920\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":31,\"name\":\"TestProduct1706\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":33,\"name\":\"TestProduct1093\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":34,\"name\":\"TestProduct1089\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":36,\"name\":\"TestProduct1902\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":44,\"name\":\"prodName\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":46,\"name\":\"prodName\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":47,\"name\":\"TestProduct1832\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":49,\"name\":\"TestProduct1953\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":77,\"name\":\"TestProduct1032\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":104,\"name\":\"TestProduct1349\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":109,\"name\":\"TestProduct1993\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":113,\"name\":\"TestProduct1527\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":118,\"name\":\"TestProduct1440\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":123,\"name\":\"TestProduct1974\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":127,\"name\":\"TestProduct1473\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":132,\"name\":\"TestProduct1525\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":138,\"name\":\"TestProduct1097\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":236,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":242,\"name\":\"TestProduct1696\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":293,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":301,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"Farmácia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":316,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":374,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":379,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":384,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":389,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":394,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":399,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":404,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":409,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":414,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":419,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":424,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":432,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":434,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":447,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":449,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":464,\"name\":\"teste final\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"teste final\",\"description\":\"teste final\",\"price\":123,\"image\":\"image\"},{\"id\":469,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"},{\"id\":474,\"name\":\"Batata\",\"app\":{\"appid\":1,\"tax\":50,\"name\":\"appfixe\",\"address\":\"Rua fixe\",\"schedule\":\"24/7\",\"image\":\"imagemfixe\"},\"category\":\"FarmÃ¡cia Geral\",\"description\":\"Great for small pains!\",\"price\":13,\"image\":\"somebase64string\"}]";

        when(restTemplate.getForEntity(any(), any())).thenReturn(new ResponseEntity<>(body, HttpStatus.OK));

        var order = searchService.getAllProductsForClient(1L, "");

        assertThat(order.getStatusCode()).isSameAs(HttpStatus.OK);
        assertThat(order.getBody()).isEqualTo(body);

        verify(restTemplate, VerificationModeFactory.times(1)).getForEntity(any(), any());

    }

}